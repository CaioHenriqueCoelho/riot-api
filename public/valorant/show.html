<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Buscar LP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="css/style.css">
</head>

<body>
  <div id="overlay-container">
    <div class="info-group">
      <div id="name"></div>
      <div id="rank-points"></div>
      <div id="resultado">
        <span></span>
        <img class="inline-icon" src="" alt="" />
      </div>
    </div>
    <div class="info-right">
      <img id="elo-image" src="" alt="Elo do jogador" />
      <div id="kda"></div>
    </div>
  </div>

  <script>
    const TIERS = [
      "IRON", "BRONZE", "SILVER", "GOLD",
      "PLATINUM", "DIAMOND", "ASCENDANT", "IMMORTAL"
    ];
    const DIVISIONS = ["1", "2", "3"];
    const LP_POR_DIVISAO = 100;
    const CUTOFF = 340;
    const LP_POR_VITORIA = 17;

    let server = '';

    calcularVitoriasNecessarias();

    setInterval(calcularVitoriasNecessarias, 60 * 1000); // Recalcula a cada 1min
    setInterval(() => location.reload(), 20 * 60 * 1000); // Recarrega a cada 20min

async function calcularVitoriasNecessarias() {
  const jogador = await buscarDadosDoJogador();
  if (!jogador) return;

  // Desestruturação dos dados do MMR
  const { currenttierpatched, ranking_in_tier, images } = jogador.mmr;
  const [tier, division] = currenttierpatched.split(" ");

  // Atualiza a interface com os dados atuais
  atualizarUI(tier, division, ranking_in_tier, images.small);

  // Calcula winrate do dia
  const totalPartidas = jogador.today.wins + jogador.today.loses;
  const winRate = totalPartidas > 0 ? (jogador.today.wins / totalPartidas) * 100 : 0;
  const winRateFormatted = winRate.toFixed(2);

  // Define cor e símbolo com base no status do dia
  let color;
  let operador;
  switch (jogador.today.status) {
    case "positivo":
      color = "#00ff00";
      operador = "+";
      break;
    case "negativo":
      color = "#ff4d4d";
      operador = "-";
      break;
    default:
      color = "#cccccc";
      operador = "";
  }

  // Atualiza o elemento com os dados de desempenho do dia
  document.getElementById("kda").innerHTML = `
    Day:
    <span style="color: #00ff00;"> W: ${jogador.today.wins}</span> |
    <span style="color: #ff4d4d;">L: ${jogador.today.loses}</span>
    <p style="color: ${color};">RR: ${operador}${jogador.today.mmr_total} | ${winRateFormatted}%</p>
  `;

  // Cálculo de progresso para próxima divisão
  if (tier === "Radiant") {
    document.getElementById("resultado").innerText = "Você já está no Radiant!";
    return;
  }

  let pontosRestantes, vitoriasNecessarias;

  if (tier !== "Immortal") {
    pontosRestantes = calcularPontosRestantes(
      tier.toUpperCase(),
      division,
      ranking_in_tier,
      "IMMORTAL"
    ) + CUTOFF;
  } else {
    pontosRestantes = CUTOFF - ranking_in_tier;
  }

  vitoriasNecessarias = Math.ceil(pontosRestantes / LP_POR_VITORIA);
  exibirResultado(pontosRestantes, vitoriasNecessarias);
}


    async function buscarDadosDoJogador() {
      const query = window.location.href.split('?')[1];
      if (!query) return exibirErro("Coloque na URL: ?region=br1/nomedojogador#tag");

      const match = query.match(/^region=([^\/]+)\/([^#]+)#(.+)$/);
      if (!match) return exibirErro("Formato inválido. Use: ?region=br1/nome#tag");

      [, server, name, tag] = match;
      const nickname = decodeURIComponent(`${name}#${tag}`);
      document.getElementById("name").innerText = nickname;

      try {
        const res = await fetch(`/api/riot-valorant/player/${server}/${name}/${tag}`);
        const data = await res.json();
        console.log("jogador??",data);
        if(data.error){
          return exibirErro("MMR Do jogador não encontrado");
        }
        return data;
      } catch (error) {
        console.error("Erro ao buscar dados:", error);
        return exibirErro("Erro ao buscar dados da API.");
      }
    }

    function calcularPontosRestantes(tierAtual, divisaoAtual, lpAtual, tierAlvo) {
      console.log("lp atual", lpAtual, tierAtual, divisaoAtual, tierAlvo);
      const tierIndexAtual = TIERS.indexOf(tierAtual);
      const divisaoIndexAtual = DIVISIONS.indexOf(divisaoAtual);
      const tierIndexAlvo = TIERS.indexOf(tierAlvo);

      console.log(tierIndexAlvo, divisaoIndexAtual, tierIndexAlvo);

      if (tierIndexAtual === -1 || divisaoIndexAtual === -1 || tierIndexAlvo === -1 || tierIndexAlvo <= tierIndexAtual) {
        console.log("caiu fora");
        return 0;
      }

      let pontosRestantes = (DIVISIONS.length - divisaoIndexAtual - 1) * LP_POR_DIVISAO;
      pontosRestantes += LP_POR_DIVISAO - lpAtual;

      for (let i = tierIndexAtual + 1; i < tierIndexAlvo; i++) {
        pontosRestantes += DIVISIONS.length * LP_POR_DIVISAO;
      }
      console.log("pontos restantes ", pontosRestantes);
      return pontosRestantes;
    }

    function atualizarUI(tier, divisao, lp, imagemElo) {
      document.getElementById("elo-image").src = imagemElo;
      document.getElementById("rank-points").innerText = divisao
        ? `${tier} ${divisao} - ${lp} LP`
        : `${tier} - ${lp} LP`;
    }

    function exibirResultado(pontosRestantes, vitoriasNecessarias) {
      const resultado = document.getElementById("resultado");
      resultado.innerHTML = pontosRestantes <= 0
        ? `Parabéns! Você conseguiu!!!`
        : `${vitoriasNecessarias} Wins para o 
          <img src="https://imgsvc.trackercdn.com/url/max-width(180),quality(70)/https%3A%2F%2Ftrackercdn.com%2Fcdn%2Ftracker.gg%2Fvalorant%2Ficons%2Ftiersv2%2F27.png/image.png"
               alt="Immortal"
               class="inline-icon" />`;
    }

    function exibirErro(msg) {
      document.getElementById("resultado").innerText = msg;
      return null;
    }
  </script>
</body>
</html>
